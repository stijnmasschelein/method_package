---
title: "Introduction to Research Methods"
author: "Stijn Masschelein"
date: "`r format(Sys.Date(), '%B, %Y')`"
output:
  slidy_presentation:
    css: styles_presentation.css
    font_adjustment: +1
    highlight: kate
    fig.width: 6
    fig.height: 4
---

# Introduction

## Packages and helper function

```{r}
pretty_ols = function(lm, digits = 2){
  knitr::kable(apply(coefficients(summary(lm)), 1:2, 
                function(x) prettyNum(x, dig = digits)),
               format = "markdown")
}
library(tidyverse)
library(lubridate)
library(cowplot)
library(DiagrammeR)
library(viridis)
```

## Revision

<div class="content_slide">
```{r libby-boxes-1, fig.cap = 'Libby Boxes', fig.align = 'center', echo = FALSE}
grViz("
    digraph libby_boxes{
    graph [fontsize = 18, layout = 'dot'] 
    
    node [shape = box, group = 'cause_group']
    cause [label = 'Performance']
    m_cause [label = 'Change_Log_Value']
    node [shape = box, group = 'effect_group']
    effect [label = 'Pay']
    m_effect [label = 'Change_Log_Wealth']
    controls
    
    cause -> effect [label = '(1)']
    m_cause -> m_effect [label = '(2)']
    cause -> m_cause [label = ' (3) ']
    effect -> m_effect [label = ' (4) ']
    m_effect -> controls [dir=back, label = '(5)']
    
    subgraph{
    rank = same; cause; effect;
    }
    subgraph{
    rank = same; m_cause; m_effect; controls;
    }
  }
")
```
</div>

## The data

```{r combined-control}
us_comp <- readRDS("data/us-compensation.RDS") %>%
  rename(total_comp = tdc1, shares = shrown_tot_pct)
us_value <- readRDS("data/us-value.RDS") %>%
  rename(year = fyear, market_value = mkvalt)
us_firm <- readRDS("data/us-company.RDS") %>%
  mutate(comp_age = dmy("31-12-2018") - begdat)

combined <- left_join(us_comp, us_firm, by = "cusip") %>%
  left_join(us_value, by = c("year", "gvkey")) %>%
  mutate(ipo_ceo = I(becameceo < begdat),
         ipo_employee = I(joined_co < begdat),
         wealth = shares * market_value / 100) %>%
  mutate(ipo_employee = if_else(is.na(ipo_employee), ipo_ceo,
                                ipo_employee)) %>%
  mutate(ipo = ifelse(ipo_ceo, "ceo",
                      ifelse(ipo_employee, "employee", "none")))

combined_change <- group_by(combined, gvkey) %>%
  arrange(year) %>%
  mutate(
    delta_total = log(total_comp) - log(lag(total_comp)),
    delta_wealth = log(wealth) - log(lag(wealth)),
    delta_value = log(market_value) - log(lag(market_value))) %>%
  filter(!is.infinite(delta_total),
         !is.infinite(delta_value),
         !is.infinite(delta_wealth),
         year > 2011)
```

## Directed Acyclical Graphs (or DAG)

<div class="content_slide">
```{r dag-joey, echo = FALSE}
grViz("
    digraph dag_joey{
    node [shape = box]
    inst_own_before; xbrl; inst_own_after; size;
    price_info; info_envir;
    size -> {xbrl, inst_own_before};
    {xbrl, inst_own_before} -> info_envir ;
    info_envir -> {inst_own_after; price_info}
    inst_own_before -> inst_own_after
    }
")
```
</div>

# Controlling for measurement error

## DAG

<div class="content_slide">
```{r dag-measurement, echo = FALSE}
grViz("
    digraph measurement_error{
    node [shape = box]
    x
    y
    z
    x -> y
    z -> y
    }
")
```
</div>

## Simulation

<div class="content_slide_wide">
```{r, results = 'asis'}
set.seed(830323)
obs = 500
x <- rnorm(n = obs); z <- rnorm(n = obs)
y <- rnorm(n = obs, mean = 1 * x + 10 * z, sd = 10)
d <- tibble(y = y, x = x, z = z)
yx <- lm(y ~ x, data = d)
yxz <- lm(y ~ x + z, data = d)
pretty_ols(yx)
pretty_ols(yxz)
```
</div>

## Real data

```{r, echo = FALSE, fig.align='center', fig.height = 6}
meas_data <-  select(combined, market_value, shares, ipo) %>%
              filter(complete.cases(.))
ownership <-
  ggplot(data = meas_data,
      aes(x = market_value/1000, y = shares + 0.001)) +
  geom_point(na.rm = T) +
  scale_x_continuous(trans = "log",
    breaks = scales::log_breaks(n = 5, base = 10),
    labels = function(x) prettyNum(x, dig = 2)) +
  scale_y_continuous(trans = "log",
    breaks = scales::log_breaks(n = 5, base = 10),
    labels = function(x) prettyNum(x, dig = 2),
    limits = c(NA, 50)) +
  labs(y = "CEO ownership", x = "Market Value in $ Billion")
print(ownership)
```

## Founders and early employees

<div class="content_slide_wide">
```{r, results = 'asis'}
form <- log(shares + 0.001) ~ log(market_value/1000)
base <- lm(form, data = combined)
form_error <- update(form, . ~ . + ipo_ceo + ipo_employee)
error <- lm(form_error, data = combined)
pretty_ols(base)
pretty_ols(error)
```
</div>
  
## Pre IPO employees and CEOs

<div class="content_slide">
```{r, results = 'asis'}
combined %>% select(ipo_ceo, ipo_employee, year) %>%
  group_by(year) %>%
  summarise(
    ipo_both = mean(ipo_ceo * ipo_employee, na.rm = T),
    ipo_ceo_only = mean(ipo_ceo * (1 - ipo_employee),
                        na.rm = T),
    ipo_empl_only = mean((1 - ipo_ceo) * ipo_employee,
                         na.rm = T),
    ipo_none = mean((1 - ipo_ceo) * (1 - ipo_employee),
                    na.rm = T)
  ) %>% knitr::kable(digits = 2, 'markdown')
```
</div>

## Visualisation of pre IPO employees and CEOs

```{r, echo = FALSE, fig.align = 'center'}
own_color <- ownership + 
  geom_point(aes(color = ipo), na.rm = T) +
  scale_colour_viridis_d()
print(own_color)
```

## Visulation of controlling

```{r, echo = FALSE, fig.align = 'center'}
mshares <- mean(log(meas_data$shares + 0.001))
mvalue <- mean(log(meas_data$market_value/1000))
meas_sum <- group_by(meas_data, ipo) %>%
  summarise(shares = exp(mean(log(shares + 0.001)) + 0.001),
            market_value = exp(mean(log(market_value/1000))))
own_means <- own_color + 
  geom_hline(data = meas_sum, 
             mapping = aes(yintercept = shares,
                           group = ipo, color = ipo)) + 
  geom_vline(data = meas_sum,
             mapping = aes(xintercept = market_value,
                           group = ipo, color = ipo))
meas_data_adj <- left_join(meas_data, meas_sum, by = "ipo") %>%
  mutate(market_value = exp(log(market_value.x/1000) -
                              log(market_value.y) + mvalue),
         shares = exp(log(shares.x + 0.001) 
                      - log(shares.y + 0.001) + mshares) + 0.001)
own_adjust <- 
  ggplot(data = meas_data_adj, 
         aes(group = ipo, colour = ipo,
             y = shares, x = market_value)) + 
  geom_point(na.rm = T) + 
  scale_colour_viridis_d() +
  scale_x_continuous(trans = "log", 
    breaks = scales::log_breaks(n = 5, base = 10),
    labels = function(x) prettyNum(x, dig = 2)) + 
  scale_y_continuous(trans = "log", 
    breaks = scales::log_breaks(n = 5, base = 10),
    labels = function(x) prettyNum(x, dig = 2),
    limits = c(NA, 50)) +
  labs(y = "Adjusted CEO ownership", 
       x = "Adjusted Market Value in $ Billion") +
  geom_hline(yintercept = exp(mshares) + 0.001) + 
  geom_vline(xintercept = exp(mvalue))
plot_meas <- plot_grid(
  own_means + theme(legend.position = "top"),
  own_adjust + theme(legend.position = "top"), ncol = 2)
print(plot_meas)
```

## Interaction effect

```{r, echo = FALSE, fig.align='center'}
own_interaction <- own_color + 
  geom_smooth(mapping = aes(group = ipo, color = ipo),
              method = "lm", formula = y ~ x,
              na.rm = T)
print(own_interaction)
```

## Interaction effect

<div class="content_slide_wide">
```{r}
form_interaction <- update(form, . ~ log(market_value/1000) 
                        * (ipo_ceo + ipo_employee))
interaction <- lm(form_interaction, data = combined)
pretty_ols(interaction)
```
</div>

## Interaction effect and measurement error

<div class="content_slide">
```{r}
c <- sqrt(1/3)
3 * c^2
mfc <- tibble(
  mother = rnorm(obs, 0, 1),
  father = rnorm(obs, 0, 1),
  divorce = rbinom(obs, size = 1, prob = .2),
  child = rnorm(obs, mean = c * (1 - divorce) * father 
                            + c * mother, sd = c)
)
```
</div>

## Interaction effect and measurement error

<div class="content_slide">
```{r, results='asis'}
group_by(mfc, divorce) %>%
  summarise(cor_mother_child = cor(child, mother),
            sd_child = sd(child)) %>%
  knitr::kable(digits = 2, 'markdown')

pretty_ols(lm(child ~ mother * divorce, data = mfc))
pretty_ols(lm(child ~ mother + father * divorce, data = mfc))
```
</div>

# Controlling for confounding factors

## DAG

```{r dag-confounding, echo = FALSE, fig.align='center'}
grViz("
    digraph confounding{
    node [shape = box]
    subgraph{
    rank = same; x; y;
    }
    z
    x -> y
    z -> {y x}
    }
")
```


## Simulation

<div class="content_slide_wide">
```{r}
xyz = tibble(
  z = rnorm(obs, 0, 5),
  x = rnorm(obs, 1 + z, 5),
  y = rnorm(obs, 1 + 2 * z, 5),
)
pretty_ols(lm(y ~ x, data = xyz), dig = 2)
pretty_ols(lm(y ~ x + z, data = xyz), dig = 2)
```
</div>

## Real Data

<div class="content_slide">
```{r data-confound}
mean_delta <- filter(combined_change, !is.na(delta_value),
                     !is.na(delta_wealth)) %>%
  group_by(year) %>%
  summarise(delta_market = mean(delta_value),
            delta_total_market = mean(delta_total),
            delta_wealth_market = mean(delta_wealth)) %>%
  ungroup()
d_conf <- ungroup(combined_change) %>%
  filter(!is.na(delta_value)) %>%
  select(delta_value, delta_total, delta_wealth, 
         gvkey, year, ipo_employee) %>%
  left_join(mean_delta, by = "year")
```
</div>

## Controlling for average market returns

<div class="content_slide">
```{r}
form <- delta_total ~ delta_value
pretty_ols(lm(form, data = d_conf))
form_conf <- update(form, . ~ . + delta_market)
pretty_ols(lm(form_conf, data = d_conf))
```
</div>

## Visualisation

<div class="content_slide_wide">
```{r}
resid_total <-  residuals(lm(delta_total ~ delta_market, d_conf))
resid_value <- residuals(lm(delta_value ~ delta_market, d_conf))
d_conf <- mutate(d_conf,
                 resid_total = resid_total,
                 resid_value = resid_value) 
```
</div>

```{r, echo = FALSE, fig.align='center', fig.height=5, fig.width=10}
plot_conf <- ggplot(data = d_conf, 
               aes(y = delta_total, x = delta_value, 
                   colour = delta_market))
plot_conf <- plot_conf + geom_point(alpha = .75, na.rm = T) 
plot_conf <- plot_conf + scale_colour_viridis()
plot_conf <- plot_conf + scale_x_continuous(limits = c(-1, 1.5)) 
plot_conf <- plot_conf + scale_y_continuous(limits = c(-1.5, 1.5))

plot_resid <- ggplot(data = d_conf, 
               aes(y = resid_total, x = resid_value, 
                   colour = delta_market))
plot_resid <- plot_resid + geom_point(alpha = .75, na.rm = T) 
plot_resid <- plot_resid + scale_colour_viridis()
plot_resid <- plot_resid + scale_x_continuous(limits = c(-1, 1.5)) 
plot_resid <- plot_resid + scale_y_continuous(limits = c(-1.5, 1.5))

plot_controlling <- plot_grid(
  plot_conf, plot_resid + theme(legend.position = 'none'),  
  labels = "AUTO", rel_widths = c(1.3, 1))
print(plot_controlling)
```

## Fixed effects

<div class="content_slide">
```{r}
form_fyear <- update(form, . ~ . - 1 + as.factor(year))
pretty_ols(lm(form_fyear, data = d_conf), 2)
```
</div>

## Visualisation Fixed Effects

```{r, echo = FALSE, fig.align='center', fig.align='center', fig.height=5}
plot_conf <- plot_conf + 
  geom_hline(aes(yintercept = delta_total_market), 
             data = mean_delta) + 
  geom_vline(aes(xintercept = delta_market),
             data = mean_delta)
d_conf <- 
  mutate(d_conf,
         delta_total_c = delta_total - delta_total_market,
         delta_wealth_c = delta_wealth - delta_wealth_market,
         delta_value_c = delta_value - delta_market)

plot_conf_c <- ggplot(data = d_conf, 
               aes(y = delta_total_c, x = delta_value_c, 
                   colour = delta_market))
plot_conf_c <- plot_conf_c + geom_point(alpha = .75, na.rm = T) 
plot_conf_c <- plot_conf_c + scale_colour_viridis()
plot_conf_c <- plot_conf_c + scale_x_continuous(limits = c(-1, 1.5)) 
plot_conf_c <- plot_conf_c + scale_y_continuous(limits = c(-1.5, 1.5))
plot_conf_c <- plot_conf_c + 
  geom_hline(aes(yintercept = mean(delta_total_c)))
plot_conf_c <- plot_conf_c + 
  geom_vline(aes(xintercept = mean(delta_value_c)))
plot_conf_c <- plot_conf_c + 
  geom_smooth(method = "lm", na.rm = T)

plot_confounding <- plot_grid(
  plot_conf, plot_conf_c + theme(legend.position = 'none'),
  rel_widths=c(1.3, 1), labels = "AUTO")
print(plot_confounding)
```

# Bad controls or 'beware the causal salad'

## Background Listening

<iframe width="400" height="225" 
src="http://www.youtube.com/embed/l_7yIUqWBmE?rel=0" 
frameborder="0" allowfullscreen></iframe>

<iframe width="400" height="225" 
src="http://www.youtube.com/embed/0Jc6Kgw5qc0?rel=0" 
frameborder="0" allowfullscreen></iframe>

## Pipe: DAG

```{r dag-pipe, fig.align='center', echo = FALSE}
grViz("
    digraph pipe{
    node [shape = box]
    subgraph{rank = same; x; y; z}
    z
    x -> z
    z -> y 
    }
")
```

## Pipe: Simulation

<div class="content_slide_wide">
```{r sim-pipe}
corp_gov <- rnorm(obs, 0, 1)
acc_profit <- rnorm(obs, corp_gov, sd = 3)
market_return <- rnorm(obs, acc_profit, sd = 5)
d <- tibble(corp_gov = corp_gov,
       acc_profit = acc_profit,
       market_return = market_return)
pretty_ols(lm(acc_profit ~ corp_gov, data = d))
pretty_ols(lm(market_return ~ corp_gov, data = d))
pretty_ols(lm(market_return ~ corp_gov + acc_profit, data = d))
```
</div>

## Colliders: DAG

```{r dag-collider, fig.align='center', echo = FALSE}
grViz("
    digraph measurement_error{
    node [shape = box]
    subgraph{rank = same; x; y}
    x -> {y, z}
    y -> z
    }
")
```

## Colliders: Coporate government

<div class="content_slide_wide">
```{r corp_gov_collider}
corp_gov <- rnorm(obs, 0, 1)
acc_profit <- rnorm(obs, corp_gov, sd = 3)
market_return <- rnorm(obs, 2 * corp_gov + acc_profit, sd = 5)
d <- tibble(corp_gov = corp_gov,
       acc_profit = acc_profit,
       market_return = market_return)
pretty_ols(lm(acc_profit ~ corp_gov, data = d))
pretty_ols(lm(acc_profit ~ corp_gov + market_return, data = d))
```
</div>

## Colliders

<div class="content_slide_wide">
```{r corp_gov_collider_regression}
d <- mutate(d, neg_return = if_else(market_return < 0, 1, 0))
pretty_ols(lm(acc_profit ~ corp_gov * neg_return, data = d))
```
</div>

## Colliders and selection bias

<div class="content_slide_wide">
```{r corp_gov_collider_selection}
pretty_ols(lm(acc_profit ~ corp_gov * neg_return, data = d),
           digits = 3)
pretty_ols(lm(acc_profit ~ corp_gov,
              data = filter(d, neg_return == 0)),
           digits = 3)
```
</div>

## Visualisation of colliders 

```{r, fig.align='center', fig.height=4, fig.width = 12, echo = FALSE}
d <- mutate(d, neg_return2 = as.character(neg_return))
plot_coll <- ggplot(d, aes(x = corp_gov, y = acc_profit))
plot_coll1 <- plot_coll + geom_point() +
  geom_smooth(method = "lm")
plot_coll2 <- plot_coll + 
  geom_point(aes(colour = neg_return2)) +
  geom_smooth(aes(colour = neg_return2, group = neg_return2),
              method = "lm") + 
  scale_colour_viridis(discrete = TRUE) + 
  theme(legend.position = 'none')
plot_coll3 <- ggplot(filter(d, neg_return == 0),
                     aes(x = corp_gov, y = acc_profit)) + 
  geom_smooth(method = "lm") + 
  scale_y_continuous(limits = c(-10, NA)) +
  geom_point()
plot_coll4 <- 
  ggplot(filter(d, percent_rank(market_return) > .75),
         aes(x = corp_gov, y = acc_profit)) + 
  geom_smooth(method = "lm") + 
  scale_y_continuous(limits = c(-10, NA)) +
  geom_point()
plot_collider <- plot_grid(
  plot_coll1, plot_coll2, plot_coll3, plot_coll4,
  nrow = 1, labels = "AUTO")  
print(plot_collider)
```

## Regression with performance as outcome variable

<div class="content_slide">
```{r}
d_perf <- ungroup(combined_change) %>%
  mutate(sensitivity = delta_total/ delta_value) %>%
  select(year, exec_fullname, gvkey, 
         sensitivity, delta_value) %>%
  group_by(exec_fullname, gvkey) %>%
  arrange(year) %>%
  mutate(prev_sensitivity = lag(sensitivity)) %>%
  ungroup %>%
  filter(complete.cases(.))

pretty_ols(lm(delta_value ~ prev_sensitivity, data = d_perf))
```
</div>


