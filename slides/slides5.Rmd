---
title: "Research Design 2: Event Studies and Difference-in-Difference Designs"
author: "Stijn Masschelein"
date: "`r format(Sys.Date(), '%B, %Y')`"
output:
    xaringan::moon_reader:
        css: "xaringan-themer.css"
        nature:
            highlightLines: true
            countIncrementalSlides: false
            ratio: 16:9
---

```{r, setup, include = FALSE}
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot(font_size = 18))
library(DiagrammeR)
library(fixest)
library(modelsummary)
library(here)
i_am("slides/slides5.Rmd")
uwa_blue = "#003087"
uwa_gold = "#DAAA00"
knitr::opts_chunk$set(dpi = 200, dev = "svg")
gof_omit = "Adj|IC|Log"
```

class: middle, center

# Event Studies

---

## A basic before event - after event comparison

<center>
```{r, fig.width=4, fig.height=1.5, fig.align="left", echo=FALSE}
grViz("
  digraph event{
  node [shape = box]
  subgraph{
    rank = same; 'Event Happened', Treatment, Outcome
  }
  'Event Happened' -> Treatment -> Outcome
  Time -> {'Event Happened', Outcome}
  }
")
```
</center>

[Chapter 17 Event Studies in The Effect]()

???

Where Time could be standing in for a lot of other annoying things that might happen. 

---

## Use Data Before The Event to Infer The Counterfactual Outcome (in Yellow)

```{r, warning = FALSE, echo = FALSE}
days <- -60:60
log_return_prior <- rnorm(60, 1.15, .3)
log_return_control <- rnorm(61, 1.15, .3)
log_return_treatment <- c(rnorm(61, 1.85, .3))
no_time_trend <-
  ggplot(mapping = aes(x = days,
                       y = c(log_return_prior,log_return_treatment))) +
  geom_line(colour = uwa_blue) +
  geom_line(aes(y = c(rep(NA, 60), log_return_control)), colour = uwa_gold) +
  ylab("log(return)") +
  ggtitle("No Time Trend") +
  geom_vline(xintercept = 0,  linetype = "longdash", colour = uwa_blue)
```

```{r, warning = FALSE, echo = FALSE}
log_return_prior_time <- rnorm(60, days * 0.01 + 1.15, .3)
log_return_control_time <- rnorm(61, (61 + days) * 0.01 + 1.15, .3)
log_return_treatment_time <- c(rnorm(61, (61 + days) * 0.01 + 0.6, .3))
time_trend <-
  ggplot(mapping = aes(x = days,
                       y = c(log_return_prior_time,
                             log_return_treatment_time))) +
  geom_line(colour = uwa_blue) +
  geom_line(aes(y = c(rep(NA, 60), log_return_control_time)),
            colour = uwa_gold) +
  ylab("log(return)") +
  ggtitle("With a Time Trend") +
  geom_vline(xintercept = 0,  linetype = "longdash", colour = uwa_blue)
```

.pull-left[
```{r, warning = FALSE, echo = FALSE, fig.height = 5}
print(no_time_trend)
```
]

--

.pull-right[
```{r, warning = FALSE, echo = FALSE, fig.height = 5}
print(time_trend)
```
]

???

We do not observe the yellow/gold returns. We have to estimate them or convince the reader that there are no trends to be expected for theoretical/institutional reasons. I will not go into the details of the estimation. Dirk will spend considerable time on the actual implementation. 

---

## Front-running, information leaking, and anticipation are all very annoying.

<center>
```{r, fig.width=4, fig.height=1, fig.align="left", echo=FALSE}
grViz("
  digraph event{
  node [shape = box]
  subgraph{
    rank = same; 'Before Block Trade', 'Large Block Trade', 'Price Impact'
  }
  'Before Block Trade' -> 'Large Block Trade' -> 'Price Impact'
  Time -> {'Before Block Trade', 'Price Impact'}
  }
")
```
</center>

--

> To gauge demand from buyers and potentially gin up interest from sellers, bankers send out lists of shares with upcoming lockup expirations, according to market participants. [(Money Stuff, Matt Levine)](https://www.bloomberg.com/opinion/articles/2022-02-16/people-are-worried-about-block-trades)

> Sometimes, bankers also engage in hypothetical conversations with buyers before they have a mandate. Asking prospective buyers whether they might be interested in certain stocks is one thing. But if there are indeed plans afoot for block sales, such conversations, even phrased hypothetically, can tip off savvy money managers. [(Money Stuff, Matt Levine)](https://www.bloomberg.com/opinion/articles/2022-02-16/people-are-worried-about-block-trades)

--

???

Go also back to Assignment 2 where we modeled the same problem when investors anticipate a donation.
---


## Mergers and Acquisitions and event study

TODO


---

class: middle, center

# Difference-in-Difference
---

## What if we had an additional control group to estimate the counterfactual?

.pull-left[
```{r, warning = FALSE, echo = FALSE, fig.height = 5}
did <- tibble(
  days = rep(-60:60),
  log_return_treatment = c(rnorm(60, 1.15, .15), rnorm(61, 1.85, .15)),
  log_return_counterfactual = c(rep(NA, 60), rnorm(61, 1.15, .15)),
  log_return_control = c(rnorm(121, .5, .15))
)

event_study <- ggplot(
  did, aes(x = days, y = log_return_treatment)) +
  geom_line(colour = uwa_blue) +
  geom_line(aes(y = log_return_counterfactual), colour = uwa_gold) +
  ylab("log(return)") +
  ggtitle("Event Study") +
  geom_vline(xintercept = 0,  linetype = "longdash", colour = uwa_blue)
print(event_study)
```
]

--

.pull-right[
```{r, warning = FALSE, echo = FALSE, fig.height = 5}
event_study +
  geom_line(aes(y = log_return_control), colour = uwa_blue) + 
  ggtitle("Difference in Difference")
```
]

---

# When should you cluster?

### [Abadie, Athey, Imbens, and Wooldridge (2017)](http://economics.mit.edu/files/13927)

> What is the level of the treatment variable? What is the comparison?

- Mixed *race* or same sex *race*
- *State* legislation
- *Country* legislation
- *Firm* corporate governance changes 
