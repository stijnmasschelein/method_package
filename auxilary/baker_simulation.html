<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Stijn Masschelein">

<title>Baker et al.&nbsp;simulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="baker_simulation_files/libs/clipboard/clipboard.min.js"></script>
<script src="baker_simulation_files/libs/quarto-html/quarto.js"></script>
<script src="baker_simulation_files/libs/quarto-html/popper.min.js"></script>
<script src="baker_simulation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="baker_simulation_files/libs/quarto-html/anchor.min.js"></script>
<link href="baker_simulation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="baker_simulation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="baker_simulation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="baker_simulation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="baker_simulation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="baker_simulation_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="baker_simulation_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#r-setup" id="toc-r-setup" class="nav-link" data-scroll-target="#r-setup">R Setup</a></li>
  <li><a href="#wrds" id="toc-wrds" class="nav-link" data-scroll-target="#wrds">WRDS</a></li>
  <li><a href="#create-data" id="toc-create-data" class="nav-link" data-scroll-target="#create-data">Create Data</a></li>
  <li><a href="#decomposition" id="toc-decomposition" class="nav-link" data-scroll-target="#decomposition">Decomposition</a></li>
  <li><a href="#sampling" id="toc-sampling" class="nav-link" data-scroll-target="#sampling">Sampling</a></li>
  <li><a href="#analyse" id="toc-analyse" class="nav-link" data-scroll-target="#analyse">Analyse</a>
  <ul class="collapse">
  <li><a href="#two-way-fixed-effects" id="toc-two-way-fixed-effects" class="nav-link" data-scroll-target="#two-way-fixed-effects">Two-way Fixed Effects</a></li>
  <li><a href="#sun-and-abraham" id="toc-sun-and-abraham" class="nav-link" data-scroll-target="#sun-and-abraham">Sun and Abraham</a>
  <ul class="collapse">
  <li><a href="#explanation-of-sample-selection" id="toc-explanation-of-sample-selection" class="nav-link" data-scroll-target="#explanation-of-sample-selection">Explanation of Sample Selection</a></li>
  <li><a href="#the-code" id="toc-the-code" class="nav-link" data-scroll-target="#the-code">The code</a></li>
  <li><a href="#explanation-of-the-code" id="toc-explanation-of-the-code" class="nav-link" data-scroll-target="#explanation-of-the-code">Explanation of the code</a></li>
  </ul></li>
  <li><a href="#callaway-and-santanna" id="toc-callaway-and-santanna" class="nav-link" data-scroll-target="#callaway-and-santanna">Callaway and Sant’Anna</a>
  <ul class="collapse">
  <li><a href="#the-code-1" id="toc-the-code-1" class="nav-link" data-scroll-target="#the-code-1">The code</a></li>
  </ul></li>
  <li><a href="#true-att" id="toc-true-att" class="nav-link" data-scroll-target="#true-att">True ATT</a></li>
  </ul></li>
  <li><a href="#simulation" id="toc-simulation" class="nav-link" data-scroll-target="#simulation">Simulation</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Baker et al.&nbsp;simulation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Stijn Masschelein </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This is a non necessarily coherent collection of code that I used to develop my course material to teach the <span class="citation" data-cites="baker2022">Baker, Larcker, and Wang (<a href="#ref-baker2022" role="doc-biblioref">2022</a>)</span> paper on staggered difference-in-difference, specifically simulation 6. I used the opportunity to familiarise myself with some of the <a href="https://sebkrantz.github.io/fastverse/">fastverse packages</a> and I sprinkled some timing tests in the code here and there.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. If you are going to work with large datasets and just summarising the data takes a lot of computing time, switching over from the tidyverse to (some of) the fastverse packages might be a worthwhile investment of your time. My other interest in writing this all up is that it will allow me to test other estimators and other data generating processes.</p>
</section>
<section id="r-setup" class="level1">
<h1>R Setup</h1>
<p>The <code>here</code> package helps with managing the different files associated with my teaching material. The <code>tidyverse</code> is what I normally use for data management and what I teach because I like the pedagogy but it’s not as fast compared to <code>data.table</code> and <code>collapse</code>. <code>cowplot</code> is my preference for decent default in plots. <code>RPostgress</code> is necessary to get the data from the WRDS server. <code>fixest</code> is the gold standard for regression estimators with fixed effects as of the time of writing. <code>modelsummary</code> is a package to create tables from regression objects. <code>gof_omit</code> and <code>stars</code> will override some of the defaults in <code>modelsummary.</code>run_wrds` is just a boolean to control whether I want to rerun the WRDS query.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at /Users/stijnmasschelein/Dropbox/Teaching/lecturenotes/method_package</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2
──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ ggplot2 3.4.0     ✔ purrr   1.0.1
✔ tibble  3.1.8     ✔ dplyr   1.1.0
✔ tidyr   1.3.0     ✔ stringr 1.5.0
✔ readr   2.1.3     ✔ forcats 1.0.0
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_cowplot</span>())</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>collapse 1.9.2, see ?`collapse-package` or ?`collapse-documentation`

Attaching package: 'collapse'

The following object is masked from 'package:stats':

    D</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'data.table'

The following objects are masked from 'package:dplyr':

    between, first, last

The following object is masked from 'package:purrr':

    transpose</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'fixest'

The following object is masked from 'package:collapse':

    fdim</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gof_omit <span class="ot">=</span> <span class="st">"IC|Log|Adj|Ps"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>stars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"*"</span> <span class="ot">=</span> <span class="fl">0.1</span>, <span class="st">"**"</span> <span class="ot">=</span> .<span class="dv">05</span>, <span class="st">"***"</span> <span class="ot">=</span> .<span class="dv">01</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">i_am</span>(<span class="st">"auxilary/baker_simulation.Rmd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at /Users/stijnmasschelein/Dropbox/Teaching/lecturenotes/method_package</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"roas.RDS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wrds" class="level1">
<h1>WRDS</h1>
<p>The data comes from WRDS which has <a href="https://wrds-www.wharton.upenn.edu/pages/support/programming-wrds/programming-r/r-from-your-computer/">pretty good documentation</a> on how to set up <code>R</code> and <code>Rstudio</code> to work. You do need an WRDS account though and they are not cheap. The code in this section does not run by default. <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>wrds <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">Postgres</span>(),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">host=</span><span class="st">'wrds-pgdata.wharton.upenn.edu'</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">port=</span><span class="dv">9737</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dbname=</span><span class="st">'wrds'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">user=</span><span class="st">'stimas'</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sslmode=</span><span class="st">'require'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I used <a href="https://github.com/andrewchbaker/JFE_DID/blob/main/Code/1e.%20Alternative%20Event%20Study%20Estimators.R">Andrew Baker’s Github repository</a> for the paper to replicate the underlying data but implement them in my own way. I don’t fully replicate the sample but it’s good enough for the example. I have slightly more observations and one day I will figure out where I went wrong.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>sql1 <span class="ot">&lt;-</span> <span class="st">"SELECT fyear, gvkey, oibdp, at, sich</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="st">       FROM COMP.FUNDA</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="st">       WHERE fyear &gt; 1978 AND fyear &lt; 2016 AND indfmt = 'INDL' AND datafmt = 'STD'</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">       AND popsrc = 'D' AND consol = 'C' AND fic = 'USA'"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(wrds, sql1)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">dbFetch</span>(res)) <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dbClearResult</span>(res)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>roas <span class="ot">&lt;-</span> dt <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">year =</span> fyear, <span class="at">firm =</span> gvkey) <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(year), <span class="sc">!</span><span class="fu">is.na</span>(at), <span class="sc">!</span><span class="fu">is.na</span>(oibdp), at <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(firm) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">roa =</span> oibdp <span class="sc">/</span> <span class="fu">lag</span>(at)) <span class="sc">%&gt;%</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, firm, roa, sich) <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(roa), year <span class="sc">&gt;</span> <span class="dv">1979</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(roas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sql2 <span class="ot">&lt;-</span> <span class="st">"SELECT gvkey, incorp, sic FROM crsp.comphead"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(wrds, sql2)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>dt2 <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">dbFetch</span>(res)) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dbClearResult</span>(res)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>roas <span class="ot">&lt;-</span> <span class="fu">rename</span>(dt2, <span class="at">firm =</span> gvkey) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(incorp) <span class="sc">&amp;</span> incorp <span class="sc">%in%</span> state.abb) <span class="sc">%&gt;%</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(roas) <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sich =</span> <span class="fu">coalesce</span>(sich, sic)) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sich <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6000</span><span class="sc">:</span><span class="dv">6999</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>roas <span class="ot">&lt;-</span> roas <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(firm) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_tally</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(roas)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a> <span class="co"># winsorize ROA at 99, and censor at -1</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>wins <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># winsorize and return</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">case_when</span>(</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(x) <span class="sc">~</span> <span class="cn">NA_real_</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">&gt;</span> <span class="fu">quantile</span>(x, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">~</span> <span class="fu">quantile</span>(x, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> x</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># winsorize ROA by year</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>roas <span class="ot">&lt;-</span> roas <span class="sc">%&gt;%</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">roa =</span> <span class="fu">wins</span>(roa)) <span class="sc">%&gt;%</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(firm, year) <span class="sc">%&gt;%</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Saving the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(roas, file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-data" class="level1">
<h1>Create Data</h1>
<p>Let’s read the data back in.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>roas <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file) </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mtime <span class="ot">&lt;-</span> <span class="fu">file.info</span>((file))<span class="sc">$</span>mtime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data was last modified on 2023-02-06 17:01:17</p>
</section>
<section id="decomposition" class="level1">
<h1>Decomposition</h1>
<p>If you are interested in creating you are own Baker file this is less relevant. It’s just my experimentation with the <code>collapse</code> package to mimic a naive calculation of year and time fixed effects with <code>dplyr</code>. Long story short, <code>decomp_dplyr</code> is almost 10 times slower than <code>decomp_fast</code>. With decent sized data and simulation exercises I am definitely more motivated to use the <code>fastverse</code> packages now. <code>decomp_fixest</code> is the correct decomposition in year and firm fixed effects. It’s not directly comparable to the other decompositions but given that it is actually the correct thing, it holds up pretty well in the timing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>decomp_dplyr <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>roas <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fey =</span> <span class="fu">mean</span>(roa)) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(firm) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fef =</span> <span class="fu">mean</span>(roa)) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual =</span> roa <span class="sc">-</span> fey <span class="sc">-</span> fef)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>decomp_fast <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  roas <span class="sc">%&gt;%</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fgroup_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmutate</span>(<span class="at">fey =</span> <span class="fu">fmean</span>(roa)) <span class="sc">%&gt;%</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fgroup_by</span>(firm) <span class="sc">%&gt;%</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmutate</span>(<span class="at">fef =</span> <span class="fu">fmean</span>(roa)) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmutate</span>(<span class="at">residual =</span> roa <span class="sc">-</span> fef <span class="sc">-</span> fey)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>decomp_fixest <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">feols</span>(roa <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> firm <span class="sc">+</span> year, <span class="at">data =</span> roas)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  firm_fes <span class="ot">&lt;-</span> <span class="fu">fixef</span>(mod)<span class="sc">$</span>firm</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  year_fes <span class="ot">&lt;-</span> <span class="fu">fixef</span>(mod)<span class="sc">$</span>year</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">ff =</span> firm_fes, <span class="at">fy =</span> year_fes, <span class="at">resid =</span> <span class="fu">resid</span>(mod)))</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="at">dplyr =</span> <span class="fu">decomp_dplyr</span>(),</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                               <span class="at">collapse =</span> <span class="fu">decomp_fast</span>(),</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                               <span class="at">fixest =</span> <span class="fu">decomp_fixest</span>(),</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">times =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
     expr       min        lq       mean    median        uq       max neval
    dplyr 82.232920 83.871902  93.059136 85.689414  93.11378 154.58243    20
 collapse  5.263328  7.391304   9.000915  9.030829  10.43670  13.12213    20
   fixest 84.847873 91.635498 108.445625 95.797117 102.72702 196.90248    20</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>decomp <span class="ot">&lt;-</span> <span class="fu">decomp_fixest</span>()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(decomp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ ff   : Named num [1:12656] 0.08 0.153 -0.139 0.27 0.111 ...
  ..- attr(*, "names")= chr [1:12656] "1003" "1004" "1007" "1009" ...
 $ fy   : Named num [1:36] 0.033894 0.02851 -0.002754 0 -0.000273 ...
  ..- attr(*, "names")= chr [1:36] "1980" "1981" "1982" "1983" ...
 $ resid: num [1:180443] 0.2996 0.017 0.0626 0.1225 -0.0511 ...</code></pre>
</div>
</div>
</section>
<section id="sampling" class="level1">
<h1>Sampling</h1>
<p>Now we can create new samples with the above derived fixed effects for the ROAs. I use the <code>data.table</code> package for most of the data manipulation. The first bit of code prepares everything that does not change across conditions in the <code>observations</code> data. We keep the identifier for the firm and year. The new <code>firms</code> data keeps the firm fixed effects the <code>years</code> data has the year firm fixed effects from the decomposition above. The <code>residuals</code> are stored as a vector and will represent the empirical distribution of the unexplaind part of the ROAs. The remaining variables reflect the treatment effects which are applied to three groups of states which are randomly assigned to one of the three groups <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">fnrow</span>(roas)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sigma_roa <span class="ot">&lt;-</span> <span class="fu">sd</span>(roas<span class="sc">$</span>roa)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>observations <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">fselect</span>(roas, year, firm))</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>observations[, firm <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(firm)]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>firms <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">firm =</span> <span class="fu">as.numeric</span>(<span class="fu">names</span>(decomp<span class="sc">$</span>ff)), <span class="at">fef =</span> decomp<span class="sc">$</span>ff)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">names</span>(decomp<span class="sc">$</span>fy)), <span class="at">fey =</span> decomp<span class="sc">$</span>fy)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>residuals <span class="ot">&lt;-</span> decomp<span class="sc">$</span>res</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>treatment_groups <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1989</span>, <span class="dv">1998</span>, <span class="dv">2007</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>treatment_effects <span class="ot">&lt;-</span> <span class="fu">c</span>(.<span class="dv">05</span>, .<span class="dv">03</span>, .<span class="dv">01</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>state_treatments <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">50</span>, <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead of explaining the average treatment effect per row I am just plotting them below. Behold the data generating process for simulation 6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>plot_dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">year =</span> <span class="fu">rep</span>(<span class="dv">1980</span><span class="sc">:</span><span class="dv">2015</span>, <span class="dv">3</span>),</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">group =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">each =</span> <span class="dv">36</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plot_dt[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">roa =</span> <span class="fu">pmax</span>(year <span class="sc">-</span> treatment_groups[group] <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>               <span class="sc">*</span> treatment_effects[group] <span class="sc">*</span> sigma_roa,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">label =</span> <span class="fu">ifelse</span>(year <span class="sc">==</span> <span class="dv">2012</span>, <span class="fu">paste</span>(<span class="st">"group"</span>, group, <span class="at">sep =</span> <span class="st">" "</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">NA</span>))]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>effect_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_dt, <span class="fu">aes</span>(<span class="at">y =</span> roa, <span class="at">x =</span> year, <span class="at">group =</span> group,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">label =</span> label)) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label</span>()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">save_plot</span>(<span class="fu">here</span>(<span class="st">"slides"</span>, <span class="st">"figures"</span>, <span class="st">"baker_effects.svg"</span>), effect_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 105 rows containing missing values (`geom_label()`).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(effect_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 105 rows containing missing values (`geom_label()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="baker_simulation_files/figure-html/effect_plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The actual data simulation is in the <code>new_sample</code> function which again mostly uses <code>data.table</code>. The function goes through the following steps. I think I am adding more variation than the Baker et al.&nbsp;paper. So this is by no means a one-for-one replication but it allows me to build on extensions if I so want.</p>
<ol type="1">
<li>Each firm in the firm gets allocated a random firm fixed effect based on the empirical distribution of the firm fixed effects and gets allocated to one of 50 states.</li>
<li>Based on the state, I assign the firm to a treatment group and treatment effect.</li>
<li>Each year gets a randomly sampled year fixed effect based on the empirical distribution.</li>
<li>The two fixed effects are merged to the firm-year <code>observations</code>.</li>
<li>The simulated ROA is calculated based on the fixed effects, the treatment effect, and random residuals.</li>
</ol>
<p>During the development of the function I kept track of the timing of the function. Overall, I am quite impressed how fast this was.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>new_sample <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  sample_firms <span class="ot">&lt;-</span> firms[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">fef =</span> <span class="fu">sample</span>(fef, .N, <span class="cn">TRUE</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, .N, <span class="cn">TRUE</span>))]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  sample_firms[, state_treatment <span class="sc">:</span><span class="er">=</span> state_treatments[state]]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  sample_firms[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_group =</span> treatment_groups[state_treatment],</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_effect =</span> treatment_effects[state_treatment])]</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  sample_years <span class="ot">&lt;-</span> years[, fey <span class="sc">:</span><span class="er">=</span> <span class="fu">sample</span>(fey, .N, <span class="cn">TRUE</span>)]</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  new <span class="ot">&lt;-</span> observations[</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    sample_firms, on <span class="ot">=</span> .(<span class="at">firm =</span> firm)][</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    sample_years, on <span class="ot">=</span> .(<span class="at">year =</span> year)]</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  new[, treatment <span class="sc">:</span><span class="er">=</span> treatment_effect <span class="sc">*</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>          sigma_roa <span class="sc">*</span> <span class="fu">pmax</span>(year <span class="sc">-</span> treatment_group <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">0</span>)]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  new[, roa <span class="sc">:</span><span class="er">=</span> treatment <span class="sc">+</span> fef <span class="sc">+</span> fey <span class="sc">+</span> <span class="fu">sample</span>(residuals, .N, <span class="cn">TRUE</span>)]</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  new[, rel_year <span class="sc">:</span><span class="er">=</span> year <span class="sc">-</span> treatment_group]</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.data.table</span>(new))</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(<span class="at">sample =</span> <span class="fu">new_sample</span>(), <span class="at">times =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
   expr      min      lq     mean   median       uq      max neval
 sample 52.13018 57.7662 72.21619 59.83524 62.22023 148.9813   100</code></pre>
</div>
</div>
</section>
<section id="analyse" class="level1">
<h1>Analyse</h1>
<p>For now I focus on three estimators. The traditional two-way fixed effect estimator, the <span class="citation" data-cites="sun2021">Sun and Abraham (<a href="#ref-sun2021" role="doc-biblioref">2021</a>)</span> estimator, and the <span class="citation" data-cites="callaway2021">Callaway and Sant’Anna (<a href="#ref-callaway2021" role="doc-biblioref">2021</a>)</span> estimator. The <span class="citation" data-cites="sun2021">Sun and Abraham (<a href="#ref-sun2021" role="doc-biblioref">2021</a>)</span> estimator is easy to implement as a fixed effect regression and conceptually easy to explain because the hard work is done by only using the appropriate data which allows for the appropriate comparison. The <span class="citation" data-cites="callaway2021">Callaway and Sant’Anna (<a href="#ref-callaway2021" role="doc-biblioref">2021</a>)</span> is more robust has and is easier to extend to include selection effects, automatic selection of control groups, and additional control variables.</p>
<section id="two-way-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="two-way-fixed-effects">Two-way Fixed Effects</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>new <span class="ot">&lt;-</span> <span class="fu">new_sample</span>()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>twoway <span class="ot">&lt;-</span> <span class="fu">feols</span>(roa <span class="sc">~</span> <span class="fu">ifelse</span>(year <span class="sc">&gt;=</span> treatment_group, <span class="dv">1</span>, <span class="dv">0</span>)<span class="sc">|</span> year <span class="sc">+</span> firm,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">cluster =</span> <span class="st">"state"</span>, <span class="at">data =</span> new)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(twoway)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               twoway
Dependent Var.:                                   roa
                                                     
ifelse(year&gt;=treatment_group,1,0) -0.0127*** (0.0025)
Fixed-Effects:                    -------------------
year                                              Yes
firm                                              Yes
_________________________________ ___________________
S.E.: Clustered                             by: state
Observations                                  180,443
R2                                            0.72483
Within R2                                     0.00028
---
Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(twoway)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ifelse(year &gt;= treatment_group, 1, 0) 
                          -0.01274023 </code></pre>
</div>
</div>
</section>
<section id="sun-and-abraham" class="level2">
<h2 class="anchored" data-anchor-id="sun-and-abraham">Sun and Abraham</h2>
<section id="explanation-of-sample-selection" class="level3">
<h3 class="anchored" data-anchor-id="explanation-of-sample-selection">Explanation of Sample Selection</h3>
<p>The hard work is done by making sure that we make no invalid comparisons. I try to explain this with the following figure. I assume we are only interested in the treatment effect 5 years after the implementation of the treatment. For group 3 who gets the treatment last, there is not appropriate control group (<code>no_control_group</code>) so we do not use this group after the treatment. For the other groups, we delete the data more than 5 years after treatment (<code>no_interest</code>). We are left with controls which are all pre treatment (<code>control</code>) and the 5 years of treatment in group 1 and 2 (<code>treatment</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plot_dt[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">roa =</span> roa <span class="sc">-</span> <span class="fl">0.002</span> <span class="sc">*</span> group,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_groups =</span> <span class="fu">case_when</span>(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">&gt;=</span> <span class="dv">2007</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"no_control_group"</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">-</span> treatment_groups[group] <span class="sc">&gt;</span> <span class="dv">5</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"no_interest"</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">&lt;</span> treatment_groups[group] <span class="sc">-</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"control"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">&gt;=</span> treatment_groups[group] <span class="sc">-</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"treatment"</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  ))]</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>sun_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_dt, <span class="fu">aes</span>(<span class="at">y =</span> roa, <span class="at">x =</span> year, <span class="at">group =</span> group,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>                                <span class="at">label =</span> label, <span class="at">colour =</span> sample_groups)) <span class="sc">+</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_colour_viridis</span>(<span class="at">discrete =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save_plot</span>(<span class="fu">here</span>(<span class="st">"slides"</span>, <span class="st">"figures"</span>, <span class="st">"baker_sun_sample.svg"</span>), sun_plot)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sun_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baker_simulation_files/figure-html/sun-sample-selection-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="the-code" class="level3">
<h3 class="anchored" data-anchor-id="the-code">The code</h3>
<p>The actual code to run the <span class="citation" data-cites="sun2021">Sun and Abraham (<a href="#ref-sun2021" role="doc-biblioref">2021</a>)</span> estimator is available in <code>fixest</code>. We first need to construct the cleaned data set following the figure above. Next, we run the regression with <code>fixest</code> and use the <code>sunab</code> function, which automatically creates indicators for each relative year - treatment group combination. It excludes <code>rel_year = -1</code> which is the year before the treatment and the benchmark to which all the estimated coefficients can be compared.</p>
<p>The default output for the Sun and Abraham estimator is to report the aggregated<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> relative time coefficients. The overall average treatment effect can be extracted with the summary function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>max_rel_year <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>sa_new <span class="ot">&lt;-</span> <span class="fu">new_sample</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;</span> treatment_group <span class="sc">|</span> rel_year <span class="sc">&lt;=</span> max_rel_year) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;</span> <span class="dv">2007</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(sa_new, <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"sa_new.RDS"</span>))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>sun_ab <span class="ot">&lt;-</span> <span class="fu">feols</span>(roa <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">sunab</span>(treatment_group, year)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">|</span> firm <span class="sc">+</span> year, <span class="at">cluster =</span> <span class="st">"state"</span>, <span class="at">data =</span> sa_new)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(sun_ab, <span class="at">gof_omit =</span> gof_omit, <span class="at">stars =</span> stars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table style="NAborder-bottom: 0; width: auto !important; margin-left: auto; margin-right: auto;" class="table">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> &nbsp;(1) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> year = -18 </td>
   <td style="text-align:center;"> 0.001 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.009) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -17 </td>
   <td style="text-align:center;"> 0.003 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.008) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -16 </td>
   <td style="text-align:center;"> 0.003 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.009) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -15 </td>
   <td style="text-align:center;"> 0.003 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.008) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -14 </td>
   <td style="text-align:center;"> 0.004 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.008) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -13 </td>
   <td style="text-align:center;"> −0.007 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.007) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -12 </td>
   <td style="text-align:center;"> 0.010 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.008) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -11 </td>
   <td style="text-align:center;"> 0.010 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.007) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -10 </td>
   <td style="text-align:center;"> −0.005 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.008) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -9 </td>
   <td style="text-align:center;"> −0.003 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -8 </td>
   <td style="text-align:center;"> 0.001 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -7 </td>
   <td style="text-align:center;"> −0.001 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -6 </td>
   <td style="text-align:center;"> −0.002 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -5 </td>
   <td style="text-align:center;"> 0.005 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -4 </td>
   <td style="text-align:center;"> 0.003 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -3 </td>
   <td style="text-align:center;"> 0.004 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.004) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = -2 </td>
   <td style="text-align:center;"> 0.010 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = 0 </td>
   <td style="text-align:center;"> 0.011* </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = 1 </td>
   <td style="text-align:center;"> 0.025*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = 2 </td>
   <td style="text-align:center;"> 0.042*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = 3 </td>
   <td style="text-align:center;"> 0.055*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = 4 </td>
   <td style="text-align:center;"> 0.062*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> year = 5 </td>
   <td style="text-align:center;"> 0.082*** </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 119996 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 </td>
   <td style="text-align:center;"> 0.727 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 Within </td>
   <td style="text-align:center;"> 0.005 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 0.17 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Std.Errors </td>
   <td style="text-align:center;"> by: state </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: firm </td>
   <td style="text-align:center;"> X </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: year </td>
   <td style="text-align:center;"> X </td>
  </tr>
</tbody>
<tfoot><tr><td style="padding: 0; " colspan="100%">
<sup></sup> * p &lt; 0.1, ** p &lt; 0.05, *** p &lt; 0.01</td></tr></tfoot>
</table>

</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>ATT <span class="ot">&lt;-</span> <span class="fu">coeftable</span>(<span class="fu">summary</span>(sun_ab, <span class="at">agg =</span> <span class="st">"ATT"</span>))[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ATT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04620767</code></pre>
</div>
</div>
</section>
<section id="explanation-of-the-code" class="level3">
<h3 class="anchored" data-anchor-id="explanation-of-the-code">Explanation of the code</h3>
<p>You can extract the individual coefficients for each relative year - treatment group estimation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>sun_ab<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>year::-18:cohort::1998 year::-17:cohort::1998 year::-16:cohort::1998 
          5.817226e-04           2.513727e-03           3.384670e-03 
year::-15:cohort::1998 year::-14:cohort::1998 year::-13:cohort::1998 
          3.170757e-03           4.015726e-03          -6.630800e-03 
year::-12:cohort::1998 year::-11:cohort::1998 year::-10:cohort::1998 
          1.006738e-02           9.560934e-03          -4.848666e-03 
 year::-9:cohort::1989  year::-9:cohort::1998  year::-8:cohort::1989 
          2.763809e-05          -5.460554e-03           1.624357e-03 
 year::-8:cohort::1998  year::-7:cohort::1989  year::-7:cohort::1998 
          1.323871e-03           2.621563e-04          -2.215004e-03 
 year::-6:cohort::1989  year::-6:cohort::1998  year::-5:cohort::1989 
          6.559048e-03          -1.108074e-02           1.625532e-03 
 year::-5:cohort::1998  year::-4:cohort::1989  year::-4:cohort::1998 
          8.456429e-03           4.485143e-04           5.415751e-03 
 year::-3:cohort::1989  year::-3:cohort::1998  year::-2:cohort::1989 
          8.439947e-03           2.749030e-04           1.084870e-02 
 year::-2:cohort::1998   year::0:cohort::1989   year::0:cohort::1998 
          8.304653e-03           1.639288e-02           4.905718e-03 
  year::1:cohort::1989   year::1:cohort::1998   year::2:cohort::1989 
          3.008403e-02           1.903180e-02           4.804201e-02 
  year::2:cohort::1998   year::3:cohort::1989   year::3:cohort::1998 
          3.673277e-02           6.665433e-02           4.312932e-02 
  year::4:cohort::1989   year::4:cohort::1998   year::5:cohort::1989 
          8.049357e-02           4.110970e-02           9.767706e-02 
  year::5:cohort::1998 
          6.232368e-02 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sun_ab, <span class="at">agg =</span> <span class="st">"cohort"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">msummary</span>(<span class="at">gof_omit =</span> gof_omit, <span class="at">stars =</span> stars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table style="NAborder-bottom: 0; width: auto !important; margin-left: auto; margin-right: auto;" class="table">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> &nbsp;(1) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> cohort = 1989 </td>
   <td style="text-align:center;"> 0.058*** </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> cohort = 1998 </td>
   <td style="text-align:center;"> 0.034*** </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.005) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 119996 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 </td>
   <td style="text-align:center;"> 0.727 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 Within </td>
   <td style="text-align:center;"> 0.005 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 0.17 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Std.Errors </td>
   <td style="text-align:center;"> by: state </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: firm </td>
   <td style="text-align:center;"> X </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FE: year </td>
   <td style="text-align:center;"> X </td>
  </tr>
</tbody>
<tfoot><tr><td style="padding: 0; " colspan="100%">
<sup></sup> * p &lt; 0.1, ** p &lt; 0.05, *** p &lt; 0.01</td></tr></tfoot>
</table>

</div>
</div>
</section>
</section>
<section id="callaway-and-santanna" class="level2">
<h2 class="anchored" data-anchor-id="callaway-and-santanna">Callaway and Sant’Anna</h2>
<section id="the-code-1" class="level3">
<h3 class="anchored" data-anchor-id="the-code-1">The code</h3>
<p>For the Callaway and Sant’Anna code to work we first need to set the treatment group variable to 0 for the group that is never treated (in the subsample). And the code needs to exclude all firms that don’t have any pre-treatment observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(did)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>cs_new <span class="ot">&lt;-</span> <span class="fu">filter</span>(new, year <span class="sc">&lt;</span> <span class="dv">2007</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pretreatment =</span> <span class="fu">sum</span>(year <span class="sc">&lt;</span> treatment_group), <span class="at">.by =</span> firm) <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pretreatment <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment_group =</span> <span class="fu">if_else</span>(treatment_group <span class="sc">==</span> <span class="dv">2007</span>, <span class="dv">0</span>, treatment_group))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>cs <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(<span class="at">yname =</span> <span class="st">"roa"</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">gname =</span> <span class="st">"treatment_group"</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">idname =</span> <span class="st">"firm"</span>,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">xformla =</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">est_method  =</span> <span class="st">"reg"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> cs_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pre_process_did(yname = yname, tname = tname, idname = idname, :
Dropped 8941 observations while converting to balanced panel.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>ATT_cs <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"simple"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>ATT_cs<span class="sc">$</span>overall.att</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1069678</code></pre>
</div>
</div>
</section>
</section>
<section id="true-att" class="level2">
<h2 class="anchored" data-anchor-id="true-att">True ATT</h2>
<p>The true ATT will be different if we use the full sample or restrict the treated observations to 5 years after the treatment for group 1 and 2 or any other exlusion. The following code calculates the expected true ATT for the full sample or by cohort. The <code>true_att</code> calculation exploits the linear increase in the treatment effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>true_full_att <span class="ot">&lt;-</span> <span class="fu">mean</span>((<span class="dv">2016</span> <span class="sc">-</span> treatment_groups)<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                      sigma_roa <span class="sc">*</span> treatment_effects)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>true_att <span class="ot">&lt;-</span> (max_rel_year <span class="sc">+</span> <span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> sigma_roa <span class="sc">*</span> treatment_effects</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>max_rel_years <span class="ot">&lt;-</span> <span class="fu">max</span>(treatment_groups <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> treatment_groups</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>max_rel_years</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 17  8 -1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>true_att_cs <span class="ot">&lt;-</span> (max_rel_years <span class="sc">+</span> <span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span> <span class="sc">*</span> sigma_roa <span class="sc">*</span> treatment_effects</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(true_full_att)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.100973</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(true_att)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05354629 0.03212778 0.01070926</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(true_att_cs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.145339939 0.045896823 0.001529894</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collap</span>(new[rel_year <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>], treatment <span class="sc">~</span> rel_year <span class="sc">+</span> treatment_group) <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collap</span>(treatment <span class="sc">~</span> treatment_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treatment_group  treatment
1:            1989 0.05354629
2:            1998 0.03212778
3:            2007 0.01070926</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collap</span>(new[year <span class="sc">&lt;</span> <span class="dv">2007</span> <span class="sc">&amp;</span> rel_year <span class="sc">&gt;=</span> <span class="dv">0</span>], treatment <span class="sc">~</span> rel_year <span class="sc">+</span> treatment_group) <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collap</span>(treatment <span class="sc">~</span> treatment_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treatment_group  treatment
1:            1989 0.14533994
2:            1998 0.04589682</code></pre>
</div>
</div>
</section>
</section>
<section id="simulation" class="level1">
<h1>Simulation</h1>
<p>Everything is now in place to run a simulation that simulates new data and runs the two-way fixed effect OLS estimator, the <span class="citation" data-cites="sun2021">Sun and Abraham (<a href="#ref-sun2021" role="doc-biblioref">2021</a>)</span> estimator and the <span class="citation" data-cites="callaway2021">Callaway and Sant’Anna (<a href="#ref-callaway2021" role="doc-biblioref">2021</a>)</span> estimator. I extract the estimate of the ATT from both and save them as the <code>results</code>.</p>
<p>The rest of the code runs the simulation <code>nsim</code> times and plots the estimate with the expected true ATT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>nsim <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>simulate <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">sim =</span> <span class="dv">1</span>){</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  new <span class="ot">&lt;-</span> <span class="fu">new_sample</span>()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  twoway <span class="ot">&lt;-</span> <span class="fu">feols</span>(roa <span class="sc">~</span> <span class="fu">ifelse</span>(year <span class="sc">&gt;=</span> treatment_group, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">|</span> year <span class="sc">+</span> firm, <span class="at">data =</span> new)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  twoway_coef <span class="ot">=</span> <span class="fu">coefficients</span>(twoway)[<span class="dv">1</span>]</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  sa_new <span class="ot">&lt;-</span> new[(year <span class="sc">&lt;</span> treatment_group <span class="sc">|</span> rel_year <span class="sc">&lt;=</span> <span class="dv">5</span>) <span class="sc">&amp;</span> year <span class="sc">&lt;</span> <span class="dv">2007</span>]</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  cs_new <span class="ot">&lt;-</span> <span class="fu">filter</span>(new, year <span class="sc">&lt;</span> <span class="dv">2007</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pretreatment =</span> <span class="fu">sum</span>(year <span class="sc">&lt;</span> treatment_group), <span class="at">.by =</span> firm) <span class="sc">%&gt;%</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(pretreatment <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">treatment_group =</span> <span class="fu">if_else</span>(treatment_group <span class="sc">==</span> <span class="dv">2007</span>, <span class="dv">0</span>, treatment_group))</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  sun_ab  <span class="ot">&lt;-</span> <span class="fu">feols</span>(roa <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">sunab</span>(treatment_group, year)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">|</span> firm <span class="sc">+</span> year, sa_new)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  sun_ab_att <span class="ot">&lt;-</span> <span class="fu">coeftable</span>(<span class="fu">summary</span>(sun_ab, <span class="at">agg =</span> <span class="st">"ATT"</span>))[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  cs <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">yname =</span> <span class="st">"roa"</span>,</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">gname =</span> <span class="st">"treatment_group"</span>,</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">idname =</span> <span class="st">"firm"</span>,</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">tname =</span> <span class="st">"year"</span>,</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">xformla =</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">est_method  =</span> <span class="st">"reg"</span>,</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> cs_new)</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  cs_att <span class="ot">&lt;-</span> <span class="fu">aggte</span>(cs, <span class="at">type =</span> <span class="st">"simple"</span>)<span class="sc">$</span>overall.att</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">c</span>(twoway_coef, sun_ab_att, cs_att)</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"twoway"</span>, <span class="st">"sun_abraham"</span>, <span class="st">"callaway_santanna"</span>)</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">FUN =</span> simulate, <span class="at">mc.cores =</span> 4L) <span class="sc">%&gt;%</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>  bind_rows</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>nsim, <span class="at">FUN =</span> simulate, <span class="at">mc.cores =</span> 4L) <span class="sc">%&gt;%</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     twoway           sun_abraham      callaway_santanna
 Min.   :-0.020542   Min.   :0.03186   Min.   :0.06671  
 1st Qu.:-0.014970   1st Qu.:0.03990   1st Qu.:0.10646  
 Median :-0.013693   Median :0.04294   Median :0.11395  
 Mean   :-0.013630   Mean   :0.04305   Mean   :0.11422  
 3rd Qu.:-0.012288   3rd Qu.:0.04605   3rd Qu.:0.12153  
 Max.   :-0.007518   Max.   :0.05674   Max.   :0.15027  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sim_twoway <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(estimates, <span class="fu">aes</span>(<span class="at">x =</span> twoway)) <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"twoway fixed effects"</span>) <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> true_full_att)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>sim_sun_abraham <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(estimates, <span class="fu">aes</span>(<span class="at">x =</span> sun_abraham)) <span class="sc">+</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Sun and Abraham"</span>) <span class="sc">+</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(true_att[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]))</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>sim_callaway_santanna <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(estimates, <span class="fu">aes</span>(<span class="at">x =</span> callaway_santanna)) <span class="sc">+</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Callaway and Sant'Anna"</span>) <span class="sc">+</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(true_att_cs[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]))</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="fu">save_plot</span>(<span class="fu">here</span>(<span class="st">"slides"</span>, <span class="st">"figures"</span>, <span class="st">"simulation_twoway.svg"</span>), sim_twoway)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="fu">save_plot</span>(<span class="fu">here</span>(<span class="st">"slides"</span>, <span class="st">"figures"</span>, <span class="st">"simulation_sun_abraham.svg"</span>), sim_sun_abraham)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="fu">save_plot</span>(<span class="fu">here</span>(<span class="st">"slides"</span>, <span class="st">"figures"</span>, <span class="st">"simulation_callaway_santanna.svg"</span>), sim_callaway_santanna)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sim_twoway)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baker_simulation_files/figure-html/simulation-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sim_sun_abraham)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baker_simulation_files/figure-html/simulation-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sim_callaway_santanna)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="baker_simulation_files/figure-html/simulation-3.png" class="img-fluid" width="672"></p>
</div>
</div>

</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-baker2022" class="csl-entry" role="doc-biblioentry">
Baker, Andrew C., David F. Larcker, and Charles C. Y. Wang. 2022. <span>“How Much Should We Trust Staggered Difference-in-Differences Estimates?”</span> <em>Journal of Financial Economics</em> 144 (2): 370–95. <a href="https://doi.org/10.1016/j.jfineco.2022.01.004">https://doi.org/10.1016/j.jfineco.2022.01.004</a>.
</div>
<div id="ref-callaway2021" class="csl-entry" role="doc-biblioentry">
Callaway, Brantly, and Pedro H. C. Sant’Anna. 2021. <span>“Difference-in-<span>Differences</span> with Multiple Time Periods.”</span> <em>Journal of Econometrics</em>, Themed <span>Issue</span>: <span>Treatment Effect</span> 1, 225 (2): 200–230. <a href="https://doi.org/10.1016/j.jeconom.2020.12.001">https://doi.org/10.1016/j.jeconom.2020.12.001</a>.
</div>
<div id="ref-sun2021" class="csl-entry" role="doc-biblioentry">
Sun, Liyang, and Sarah Abraham. 2021. <span>“Estimating Dynamic Treatment Effects in Event Studies with Heterogeneous Treatment Effects.”</span> <em>Journal of Econometrics</em>, Themed <span>Issue</span>: <span>Treatment Effect</span> 1, 225 (2): 175–99. <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">https://doi.org/10.1016/j.jeconom.2020.09.006</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>You may or may not be interested in this but there you go. It’s free.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>I do not.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Which is not necessarily a given. See <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3930228">this terrifying looking paper.</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>This is slightly different than in the Baker et al.&nbsp;paper. I allow that by random chance some of the groups are larger than the other while the Baker et al.&nbsp;simulation keeps the groups (almost) equal in size. I was too lazy to change it when I noticed the difference but I am also interested in what happens to the average treatment effect if some group effects are estimated more precisely so my simulation is at least consistent with that goal<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>over the groups<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>